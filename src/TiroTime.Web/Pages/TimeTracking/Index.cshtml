@page
@model TiroTime.Web.Pages.TimeTracking.IndexModel
@{
    ViewData["Title"] = "Zeiterfassung";
}

<div class="row mb-4">
    <div class="col-12">
        <h1>
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-stopwatch text-primary me-2" viewBox="0 0 16 16" style="vertical-align: text-bottom;">
                <path d="M8.5 5.6a.5.5 0 1 0-1 0v2.9h-3a.5.5 0 0 0 0 1H8a.5.5 0 0 0 .5-.5z"/>
                <path d="M6.5 1A.5.5 0 0 1 7 .5h2a.5.5 0 0 1 0 1v.57c1.36.196 2.594.78 3.584 1.64l.012-.013.354-.354-.354-.353a.5.5 0 0 1 .707-.708l1.414 1.415a.5.5 0 1 1-.707.707l-.353-.354-.354.354-.013.012A7 7 0 1 1 7 2.071V1.5a.5.5 0 0 1-.5-.5M8 3a6 6 0 1 0 .001 12A6 6 0 0 0 8 3"/>
            </svg>
            Zeiterfassung
        </h1>
    </div>
</div>

@if (Model.ActiveTimer != null)
{
    <div class="card border-primary mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="card-title mb-1">
                        @if (!string.IsNullOrEmpty(Model.ActiveTimer.ProjectColorCode))
                        {
                            <span class="badge me-2" style="background-color: @Model.ActiveTimer.ProjectColorCode">&nbsp;&nbsp;&nbsp;</span>
                        }
                        @Model.ActiveTimer.ProjectName
                    </h5>
                    <p class="text-muted mb-2">@Model.ActiveTimer.ClientName</p>
                    @if (!string.IsNullOrEmpty(Model.ActiveTimer.Description))
                    {
                        <p class="mb-0"><small>@Model.ActiveTimer.Description</small></p>
                    }
                </div>
                <div class="col-md-3 text-center">
                    <h2 class="mb-0 text-primary" id="timer-display">00:00:00</h2>
                    <small class="text-muted">Gestartet um @Model.ActiveTimer.StartTime.ToLocalTime().ToString("HH:mm")</small>
                </div>
                <div class="col-md-3 text-end">
                    <form method="post" asp-page-handler="StopTimer">
                        <input type="hidden" name="timeEntryId" value="@Model.ActiveTimer.Id" />
                        <button type="submit" class="btn btn-danger btn-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-stop-fill" viewBox="0 0 16 16">
                                <path d="M5 3.5h6A1.5 1.5 0 0 1 12.5 5v6a1.5 1.5 0 0 1-1.5 1.5H5A1.5 1.5 0 0 1 3.5 11V5A1.5 1.5 0 0 1 5 3.5"/>
                            </svg>
                            Stoppen
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="card mb-4">
        <div class="card-body">
            <form method="post" asp-page-handler="StartTimer" class="row g-3 align-items-end">
                <div class="col-md-5">
                    <label for="projectSelect" class="form-label">Projekt *</label>
                    <select class="form-select" id="projectSelect" name="projectId" required>
                        <option value="">-- Projekt auswählen --</option>
                        @foreach (var project in Model.Projects)
                        {
                            <option value="@project.Id">
                                @if (!string.IsNullOrEmpty(project.ColorCode))
                                {
                                    <text>● </text>
                                }
                                @project.Name (@project.ClientName)
                            </option>
                        }
                    </select>
                </div>
                <div class="col-md-5">
                    <label for="description" class="form-label">Beschreibung (optional)</label>
                    <input type="text" class="form-control" id="description" name="description" placeholder="Was machen Sie gerade?" />
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-success w-100">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-play-fill" viewBox="0 0 16 16">
                            <path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393"/>
                        </svg>
                        Starten
                    </button>
                </div>
            </form>
        </div>
    </div>
}

@{
    var prevMonth = Model.CurrentMonth == 1 ? 12 : Model.CurrentMonth - 1;
    var prevYear = Model.CurrentMonth == 1 ? Model.CurrentYear - 1 : Model.CurrentYear;
    var nextMonth = Model.CurrentMonth == 12 ? 1 : Model.CurrentMonth + 1;
    var nextYear = Model.CurrentMonth == 12 ? Model.CurrentYear + 1 : Model.CurrentYear;
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center gap-3">
        <h4 class="mb-0">Zeiteinträge</h4>
        <div class="btn-group">
            <a asp-page="./Index" asp-route-year="@prevYear" asp-route-month="@prevMonth" class="btn btn-outline-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-left" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0"/>
                </svg>
            </a>
            <button type="button" class="btn btn-outline-secondary" disabled>@Model.MonthName</button>
            <a asp-page="./Index" asp-route-year="@nextYear" asp-route-month="@nextMonth" class="btn btn-outline-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-right" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708"/>
                </svg>
            </a>
        </div>
    </div>
    <a asp-page="./Create" class="btn btn-outline-primary">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-lg" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2"/>
        </svg>
        Manueller Eintrag
    </a>
</div>

@if (Model.MonthEntries.Any())
{
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Datum</th>
                            <th>Projekt</th>
                            <th>Beschreibung</th>
                            <th>Von</th>
                            <th>Bis</th>
                            <th class="text-end">Dauer</th>
                            <th class="text-end">Aktionen</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var entry in Model.MonthEntries)
                        {
                            var localStart = entry.StartTime.ToLocalTime();
                            var localEnd = entry.EndTime?.ToLocalTime();

                            <tr data-entry-id="@entry.Id">
                                <td>
                                    <strong>@localStart.ToString("dd.MM.yyyy")</strong><br/>
                                    <small class="text-muted">@localStart.ToString("dddd", new System.Globalization.CultureInfo("de-DE"))</small>
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(entry.ProjectColorCode))
                                    {
                                        <span class="badge me-2" style="background-color: @entry.ProjectColorCode">&nbsp;&nbsp;&nbsp;</span>
                                    }
                                    <strong>@entry.ProjectName</strong>
                                    <br />
                                    <small class="text-muted">@entry.ClientName</small>
                                </td>
                                <td>@(entry.Description ?? "-")</td>
                                <td class="time-cell">
                                    <span class="time-display editable-time" role="button" tabindex="0">@localStart.ToString("HH:mm")</span>
                                    <input type="text" class="form-control form-control-sm time-edit d-none"
                                           value="@localStart.ToString("HH:mm")"
                                           data-field="start"
                                           placeholder="HH:mm" />
                                </td>
                                <td class="time-cell">
                                    @if (localEnd.HasValue)
                                    {
                                        <span class="time-display editable-time" role="button" tabindex="0">@localEnd.Value.ToString("HH:mm")</span>
                                        <input type="text" class="form-control form-control-sm time-edit d-none"
                                               value="@localEnd.Value.ToString("HH:mm")"
                                               data-field="end"
                                               placeholder="HH:mm" />
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">Läuft</span>
                                    }
                                </td>
                                <td class="text-end">
                                    <strong class="duration-display">@($"{(int)entry.Duration.TotalHours}:{entry.Duration:mm}")</strong>
                                </td>
                                <td class="text-end">
                                    @if (!entry.IsRunning)
                                    {
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" class="btn btn-outline-success btn-duplicate-entry" title="F\u00fcr heute duplizieren">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16">
                                                    <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1z"/>
                                                </svg>
                                            </button>
                                            <a asp-page="./Edit" asp-route-id="@entry.Id" class="btn btn-outline-secondary" title="Details bearbeiten">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-pencil" viewBox="0 0 16 16">
                                                    <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325"/>
                                                </svg>
                                            </a>
                                        </div>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                    <tfoot>
                        <tr class="table-light">
                            <th colspan="5" class="text-end">Gesamt @Model.MonthName:</th>
                            <th class="text-end"><strong>@($"{(int)Model.MonthTotal.TotalHours}:{Model.MonthTotal:mm}")</strong></th>
                            <th></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    @if (Model.ValidationWarnings.Any())
    {
        <div class="card mt-5">
            <div class="card-header" style="background-color: #fff3cd; border-bottom: 1px solid #ffecb5;">
                <h5 class="mb-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-exclamation-triangle me-2" viewBox="0 0 16 16" style="vertical-align: text-bottom;">
                        <path d="M7.938 2.016A.13.13 0 0 1 8.002 2a.13.13 0 0 1 .063.016.15.15 0 0 1 .054.057l6.857 11.667c.036.06.035.124.002.183a.2.2 0 0 1-.054.06.1.1 0 0 1-.066.017H1.146a.1.1 0 0 1-.066-.017.2.2 0 0 1-.054-.06.18.18 0 0 1 .002-.183L7.884 2.073a.15.15 0 0 1 .054-.057m1.044-.45a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767z"/>
                        <path d="M7.002 12a1 1 0 1 1 2 0 1 1 0 0 1-2 0M7.1 5.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0z"/>
                    </svg>
                    Validierungshinweise (@Model.ValidationWarnings.Count)
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th style="width: 120px;">Typ</th>
                                <th>Hinweis</th>
                                <th style="width: 120px;">Datum</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var warning in Model.ValidationWarnings)
                            {
                                <tr class="@(warning.Type == "weekend" ? "table-warning" : "table-danger")">
                                    <td>
                                        @if (warning.Type == "weekend")
                                        {
                                            <span class="badge bg-warning text-dark">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-calendar-event" viewBox="0 0 16 16">
                                                    <path d="M11 6.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5z"/>
                                                    <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5M1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4z"/>
                                                </svg>
                                                Wochenende
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-exclamation-circle" viewBox="0 0 16 16">
                                                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                                                    <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0M7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0z"/>
                                                </svg>
                                                Überschneidung
                                            </span>
                                        }
                                    </td>
                                    <td>@warning.Message</td>
                                    <td>@warning.Date.ToString("dd.MM.yyyy")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
}
else
{
    <div class="alert alert-info text-center">
        <p class="mb-0">Keine Zeiteinträge für @Model.MonthName gefunden.</p>
        <p class="mb-0">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-info-circle mb-3" viewBox="0 0 16 16">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533z"/>
                <circle cx="8" cy="4.5" r="1"/>
            </svg>
        </p>
        <h5>Noch keine Zeiteinträge heute</h5>
        <p class="text-muted">Starten Sie einen Timer oder erstellen Sie einen manuellen Eintrag.</p>
    </div>
}

<div class="mt-4 text-center">
    <a asp-page="./History" class="btn btn-outline-secondary">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-calendar3" viewBox="0 0 16 16">
            <path d="M14 0H2a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2M1 3.857C1 3.384 1.448 3 2 3h12c.552 0 1 .384 1 .857v10.286c0 .473-.448.857-1 .857H2c-.552 0-1-.384-1-.857z"/>
            <path d="M6.5 7a1 1 0 1 0 0-2 1 1 0 0 0 0 2m3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2m3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2m-9 3a1 1 0 1 0 0-2 1 1 0 0 0 0 2m3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2m3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2m3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2m-9 3a1 1 0 1 0 0-2 1 1 0 0 0 0 2m3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2m3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2"/>
        </svg>
        Alle Einträge ansehen
    </a>
</div>

@section Scripts {
    <style>
        .editable-time {
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        .editable-time:hover {
            background-color: #e9ecef;
        }
        .editable-time:focus {
            outline: 2px solid #0d6efd;
            outline-offset: 2px;
        }
    </style>

    @if (Model.ActiveTimer != null)
    {
        <script>
            // Timer calculation
            const startTime = new Date('@Model.ActiveTimer.StartTime.ToString("O")');

            function updateTimer() {
                const now = new Date();
                const diff = Math.floor((now - startTime) / 1000);

                const hours = Math.floor(diff / 3600);
                const minutes = Math.floor((diff % 3600) / 60);
                const seconds = diff % 60;

                const display =
                    String(hours).padStart(2, '0') + ':' +
                    String(minutes).padStart(2, '0') + ':' +
                    String(seconds).padStart(2, '0');

                document.getElementById('timer-display').textContent = display;
            }

            updateTimer();
            setInterval(updateTimer, 1000);
        </script>
    }

    <script>
        // Inline time editing
        document.addEventListener('DOMContentLoaded', function() {
            // Direct click on time display to edit
            document.querySelectorAll('.editable-time').forEach(timeDisplay => {
                timeDisplay.addEventListener('click', function() {
                    const cell = this.closest('.time-cell');
                    const input = cell.querySelector('.time-edit');

                    if (input) {
                        // Hide display, show input
                        this.classList.add('d-none');
                        input.classList.remove('d-none');
                        input.focus();
                        input.select();
                    }
                });
            });

            // Parse and format time input
            function parseTimeInput(input) {
                const trimmed = input.trim();

                // Empty input
                if (trimmed === '') {
                    return null;
                }

                // Already in HH:mm format
                if (trimmed.includes(':')) {
                    const timeRegex = /^([0-1]?[0-9]|2[0-3]):([0-5][0-9])$/;
                    const match = trimmed.match(timeRegex);
                    if (match) {
                        const hours = match[1].padStart(2, '0');
                        const minutes = match[2];
                        return `${hours}:${minutes}`;
                    }
                    return null;
                }

                // Only digits - parse as HHMM or HMM
                const digitsOnly = trimmed.replace(/\D/g, '');

                if (digitsOnly.length === 0) {
                    return null;
                }

                let hours, minutes;

                if (digitsOnly.length === 1 || digitsOnly.length === 2) {
                    // 1-2 digits: treat as hours (e.g., "9" -> "09:00", "14" -> "14:00")
                    hours = parseInt(digitsOnly, 10);
                    minutes = 0;
                } else if (digitsOnly.length === 3) {
                    // 3 digits: HMM format (e.g., "900" -> "09:00", "930" -> "09:30")
                    hours = parseInt(digitsOnly.substring(0, 1), 10);
                    minutes = parseInt(digitsOnly.substring(1, 3), 10);
                } else if (digitsOnly.length === 4) {
                    // 4 digits: HHMM format (e.g., "1430" -> "14:30", "0900" -> "09:00")
                    hours = parseInt(digitsOnly.substring(0, 2), 10);
                    minutes = parseInt(digitsOnly.substring(2, 4), 10);
                } else {
                    // Too many digits
                    return null;
                }

                // Validate hours and minutes
                if (hours < 0 || hours > 23 || minutes < 0 || minutes > 59) {
                    return null;
                }

                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            }

            // Auto-save on blur (when leaving the input field)
            document.querySelectorAll('.time-edit').forEach(input => {
                let originalValue = input.value;

                input.addEventListener('focus', function() {
                    originalValue = this.value;
                });

                input.addEventListener('blur', function() {
                    const cell = this.closest('.time-cell');
                    const display = cell.querySelector('.time-display');
                    const inputValue = this.value.trim();

                    // Parse and format the time
                    const formattedTime = parseTimeInput(inputValue);

                    if (formattedTime === null) {
                        // Invalid format, revert
                        this.value = originalValue;
                        this.classList.add('d-none');
                        display.classList.remove('d-none');

                        if (inputValue !== '') {
                            showToast('Ungültiges Zeitformat. Verwenden Sie HH:mm oder HHMM (z.B. 14:30, 1430, 900)', 'warning');
                        }
                        return;
                    }

                    // Update input with formatted time
                    this.value = formattedTime;

                    // Check if value changed
                    if (formattedTime !== originalValue) {
                        saveTimeChange(this);
                    } else {
                        // No change, just hide input
                        this.classList.add('d-none');
                        display.classList.remove('d-none');
                    }
                });

                // Save on Enter key
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        this.blur();
                    } else if (e.key === 'Escape') {
                        // Cancel edit
                        const cell = this.closest('.time-cell');
                        const display = cell.querySelector('.time-display');
                        this.value = display.textContent.trim();
                        this.classList.add('d-none');
                        display.classList.remove('d-none');
                    }
                });
            });

            // Duplicate button click
            document.querySelectorAll('.btn-duplicate-entry').forEach(btn => {
                btn.addEventListener('click', function() {
                    const row = this.closest('tr');
                    duplicateEntry(row);
                });
            });

            function saveTimeChange(input) {
                const row = input.closest('tr');
                const cell = input.closest('.time-cell');
                const display = cell.querySelector('.time-display');
                const entryId = row.dataset.entryId;
                const dateText = row.querySelector('td:first-child strong').textContent.trim();
                const startInput = row.querySelector('[data-field="start"]');
                const endInput = row.querySelector('[data-field="end"]');

                if (!startInput || !endInput) return;

                // Parse date (format: dd.MM.yyyy)
                const dateParts = dateText.split('.');
                const date = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;

                const formData = new FormData();
                formData.append('id', entryId);
                formData.append('date', date);
                formData.append('startTime', startInput.value);
                formData.append('endTime', endInput.value);
                formData.append('handler', 'QuickUpdate');

                // Show loading indicator
                const originalValue = input.value;
                input.disabled = true;

                fetch('?handler=QuickUpdate', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update display text
                        display.textContent = input.value;
                        // Update duration
                        row.querySelector('.duration-display').textContent = data.duration;

                        // Hide input, show display
                        input.classList.add('d-none');
                        display.classList.remove('d-none');

                        showToast('Zeit erfolgreich aktualisiert', 'success');
                    } else {
                        alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
                        input.value = originalValue;
                    }
                })
                .catch(error => {
                    alert('Fehler beim Speichern: ' + error.message);
                    input.value = originalValue;
                })
                .finally(() => {
                    input.disabled = false;
                });
            }

            function duplicateEntry(row) {
                const entryId = row.dataset.entryId;
                const duplicateBtn = row.querySelector('.btn-duplicate-entry');

                if (!confirm('Möchten Sie diesen Eintrag für heute duplizieren?')) {
                    return;
                }

                // Disable button
                duplicateBtn.disabled = true;
                const originalText = duplicateBtn.innerHTML;
                duplicateBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

                const formData = new FormData();
                formData.append('id', entryId);
                formData.append('handler', 'DuplicateEntry');

                fetch('?handler=DuplicateEntry', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Eintrag erfolgreich für heute dupliziert!', 'success');
                        // Reload page after a short delay
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
                        duplicateBtn.disabled = false;
                        duplicateBtn.innerHTML = originalText;
                    }
                })
                .catch(error => {
                    alert('Fehler beim Duplizieren: ' + error.message);
                    duplicateBtn.disabled = false;
                    duplicateBtn.innerHTML = originalText;
                });
            }

            function showToast(message, type) {
                // Simple toast notification
                const toast = document.createElement('div');
                toast.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
                toast.style.zIndex = '9999';
                toast.textContent = message;
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }
        });
    </script>
}
